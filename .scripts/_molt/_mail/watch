#!/bin/bash
#
# molt-mail-watch - Check emails and trigger OpenClaw webhook on new messages
# Runs as molt user for proper isolation
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse arguments
FORCE=0
VERBOSE=0

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE=1
            shift
            ;;
        --verbose)
            VERBOSE=1
            shift
            ;;
        *)
            echo "Usage: $0 [--force] [--verbose]"
            echo "  --force    Trigger webhook even if no new mail"
            echo "  --verbose  Show detailed output"
            exit 1
            ;;
    esac
done

# Get molt name from home directory
MOLT_NAME=$(basename "$HOME")

# Paths
STATE_DIR="$HOME/.mail-state"
STATE_FILE="$STATE_DIR/last-check.json"
MBSYNCRC="$HOME/.mbsyncrc"
MSMTPRC="$HOME/.msmtprc"
MAILDIR_BASE="$HOME/Maildir"
OPENCLAW_DIR="$HOME/.openclaw"

# Ensure state directory exists
mkdir -p "$STATE_DIR"

log() {
    if [[ $VERBOSE -eq 1 ]]; then
        echo -e "${BLUE}[mail-watch]${NC} $1"
    fi
}

error() {
    echo -e "${RED}[mail-watch] Error:${NC} $1" >&2
}

success() {
    if [[ $VERBOSE -eq 1 ]]; then
        echo -e "${GREEN}[mail-watch]${NC} $1"
    fi
}

# Check if mbsync is configured
if [[ ! -f "$MBSYNCRC" ]]; then
    error "No mbsync configuration found at $MBSYNCRC"
    exit 1
fi

# Get list of accounts from mbsyncrc
get_accounts() {
    grep "^IMAPAccount " "$MBSYNCRC" | awk '{print $2}' | sort -u
}

# Load previous state
load_state() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo '{"lastCheck": 0, "lastUIDs": {}, "totalMessagesSeen": 0}'
    fi
}

# Save state
save_state() {
    local state="$1"
    echo "$state" > "$STATE_FILE"
    chmod 600 "$STATE_FILE"
}

# Get current message counts and newest file per account
check_maildir() {
    local account="$1"
    local maildir="$MAILDIR_BASE/$account"
    
    if [[ ! -d "$maildir" ]]; then
        echo "0|0|0"
        return
    fi
    
    # Count new messages
    local new_count=0
    if [[ -d "$maildir/new" ]]; then
        new_count=$(find "$maildir/new" -type f 2>/dev/null | wc -l)
    fi
    
    # Find newest file mtime
    local newest_mtime=0
    newest_mtime=$(find "$maildir" -type f -printf '%T@\n' 2>/dev/null | sort -rn | head -1 | cut -d. -f1)
    [[ -z "$newest_mtime" ]] && newest_mtime=0
    
    # Get sample of new messages (for webhook)
    local new_files=$(find "$maildir/new" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -5)
    
    echo "${new_count}|${newest_mtime}|${new_files}"
}

# Sync emails
log "Syncing emails..."
if ! mbsync -c "$MBSYNCRC" -a 2>/dev/null; then
    error "mbsync failed"
    exit 1
fi
success "Sync complete"

# Load state
STATE=$(load_state)
LAST_CHECK=$(echo "$STATE" | grep -o '"lastCheck":[0-9]*' | cut -d: -f2)
TOTAL_SEEN=$(echo "$STATE" | grep -o '"totalMessagesSeen":[0-9]*' | cut -d: -f2)
[[ -z "$TOTAL_SEEN" ]] && TOTAL_SEEN=0

# Check each account
CURRENT_TOTAL=0
NEW_MESSAGES_FOUND=0
NEW_EMAILS_DATA=""

ACCOUNTS=$(get_accounts)
if [[ -z "$ACCOUNTS" ]]; then
    error "No IMAP accounts configured"
    exit 1
fi

while IFS= read -r account; do
    [[ -z "$account" ]] && continue
    
    log "Checking account: $account"
    
    # Get maildir status
    result=$(check_maildir "$account")
    new_count=$(echo "$result" | cut -d'|' -f1)
    newest_mtime=$(echo "$result" | cut -d'|' -f2)
    new_files=$(echo "$result" | cut -d'|' -f3-)
    
    CURRENT_TOTAL=$((CURRENT_TOTAL + new_count))
    
    # Check if there are truly new messages (not just unread)
    # New = arrived after last check
    if [[ $new_count -gt 0 && $newest_mtime -gt $LAST_CHECK ]]; then
        NEW_MESSAGES_FOUND=1
        success "Found new messages in $account: $new_count"
        
        # Extract email info from new files
        while IFS= read -r fileinfo; do
            [[ -z "$fileinfo" ]] && continue
            
            filepath=$(echo "$fileinfo" | cut -d' ' -f2-)
            
            # Parse email headers
            from=$(grep -m1 "^From:" "$filepath" 2>/dev/null | sed 's/^From: //' | head -c 100)
            subject=$(grep -m1 "^Subject:" "$filepath" 2>/dev/null | sed 's/^Subject: //' | head -c 100)
            
            NEW_EMAILS_DATA="${NEW_EMAILS_DATA}Account: $account\\nFrom: $from\\nSubject: $subject\\n\\n"
        done <<< "$new_files"
    else
        log "No new messages in $account"
    fi
done <<< "$ACCOUNTS"

# Update state
NEW_TOTAL=$((TOTAL_SEEN + CURRENT_TOTAL))
NEW_STATE="{\"lastCheck\": $(date +%s), \"lastUIDs\": {}, \"totalMessagesSeen\": $NEW_TOTAL}"
save_state "$NEW_STATE"

# Determine if we should trigger webhook
TRIGGER=0
if [[ $FORCE -eq 1 ]]; then
    TRIGGER=1
    log "Force mode enabled - triggering webhook"
elif [[ $NEW_MESSAGES_FOUND -eq 1 ]]; then
    TRIGGER=1
    success "New messages detected - triggering webhook"
else
    log "No new messages - skipping webhook"
fi

# Trigger OpenClaw webhook if needed
if [[ $TRIGGER -eq 1 ]]; then
    log "Calling OpenClaw webhook..."
    
    # Read hook config from openclaw.json
    HOOK_TOKEN=$(grep -o '"token":[[:space:]]*"[^"]*"' "$OPENCLAW_DIR/openclaw.json" 2>/dev/null | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
    GATEWAY_PORT=$(grep -o '"port":[[:space:]]*[0-9]*' "$OPENCLAW_DIR/openclaw.json" 2>/dev/null | grep -o '[0-9]*' | head -1)
    [[ -z "$GATEWAY_PORT" ]] && GATEWAY_PORT=19001
    
    if [[ -z "$HOOK_TOKEN" ]]; then
        error "No webhook token configured in openclaw.json"
        echo "Please configure: hooks.token"
        exit 1
    fi
    
    # Prepare message
    if [[ -n "$NEW_EMAILS_DATA" ]]; then
        MESSAGE="New emails have arrived for $MOLT_NAME. Please review and process according to your mail-gatekeeper skill rules.\\n\\n${NEW_EMAILS_DATA}"
    else
        MESSAGE="Mail check triggered for $MOLT_NAME (no new messages details available)."
    fi
    
    # Call webhook
    WEBHOOK_URL="http://127.0.0.1:${GATEWAY_PORT}/hooks/agent"
    
    PAYLOAD=$(cat <<EOF
{
    "message": "$MESSAGE",
    "name": "MailCheck",
    "sessionKey": "mail:check:$(date +%s)",
    "wakeMode": "now",
    "deliver": false,
    "postToMainMode": "summary"
}
EOF
)
    
    if curl -s -X POST "$WEBHOOK_URL" \
        -H "Authorization: Bearer $HOOK_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$PAYLOAD" > /dev/null 2>&1; then
        success "Webhook triggered successfully"
    else
        error "Failed to trigger webhook at $WEBHOOK_URL"
        exit 1
    fi
fi

exit 0
